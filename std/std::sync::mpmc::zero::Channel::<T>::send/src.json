{
  "name": "std::sync::mpmc::zero::Channel::<T>::send",
  "span": "$library/std/src/sync/mpmc/zero.rs:162:5: 166:41",
  "src": "pub(crate) fn send(\n        &self,\n        msg: T,\n        deadline: Option<Instant>,\n    ) -> Result<(), SendTimeoutError<T>> {\n        let token = &mut Token::default();\n        let mut inner = self.inner.lock().unwrap();\n\n        // If there's a waiting receiver, pair up with it.\n        if let Some(operation) = inner.receivers.try_select() {\n            token.zero.0 = operation.packet;\n            drop(inner);\n            unsafe {\n                self.write(token, msg).ok().unwrap();\n            }\n            return Ok(());\n        }\n\n        if inner.is_disconnected {\n            return Err(SendTimeoutError::Disconnected(msg));\n        }\n\n        Context::with(|cx| {\n            // Prepare for blocking until a receiver wakes us up.\n            let oper = Operation::hook(token);\n            let mut packet = Packet::<T>::message_on_stack(msg);\n            inner.senders.register_with_packet(oper, (&raw mut packet) as *mut (), cx);\n            inner.receivers.notify();\n            drop(inner);\n\n            // Block the current thread.\n            // SAFETY: the context belongs to the current thread.\n            let sel = unsafe { cx.wait_until(deadline) };\n\n            match sel {\n                Selected::Waiting => unreachable!(),\n                Selected::Aborted => {\n                    self.inner.lock().unwrap().senders.unregister(oper).unwrap();\n                    let msg = unsafe { packet.msg.get().replace(None).unwrap() };\n                    Err(SendTimeoutError::Timeout(msg))\n                }\n                Selected::Disconnected => {\n                    self.inner.lock().unwrap().senders.unregister(oper).unwrap();\n                    let msg = unsafe { packet.msg.get().replace(None).unwrap() };\n                    Err(SendTimeoutError::Disconnected(msg))\n                }\n                Selected::Operation(_) => {\n                    // Wait until the message is read, then drop the packet.\n                    packet.wait_ready();\n                    Ok(())\n                }\n            }\n        })\n    }"
}