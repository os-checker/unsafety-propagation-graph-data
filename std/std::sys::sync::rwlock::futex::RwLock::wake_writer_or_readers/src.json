{
  "name": "std::sys::sync::rwlock::futex::RwLock::wake_writer_or_readers",
  "span": "$library/std/src/sys/sync/rwlock/futex.rs:269:5: 269:59",
  "src": "fn wake_writer_or_readers(&self, mut state: Primitive) {\n        assert!(is_unlocked(state));\n\n        // The readers waiting bit might be turned on at any point now,\n        // since readers will block when there's anything waiting.\n        // Writers will just lock the lock though, regardless of the waiting bits,\n        // so we don't have to worry about the writer waiting bit.\n        //\n        // If the lock gets locked in the meantime, we don't have to do\n        // anything, because then the thread that locked the lock will take\n        // care of waking up waiters when it unlocks.\n\n        // If only writers are waiting, wake one of them up.\n        if state == WRITERS_WAITING {\n            match self.state.compare_exchange(state, 0, Relaxed, Relaxed) {\n                Ok(_) => {\n                    self.wake_writer();\n                    return;\n                }\n                Err(s) => {\n                    // Maybe some readers are now waiting too. So, continue to the next `if`.\n                    state = s;\n                }\n            }\n        }\n\n        // If both writers and readers are waiting, leave the readers waiting\n        // and only wake up one writer.\n        if state == READERS_WAITING + WRITERS_WAITING {\n            if self.state.compare_exchange(state, READERS_WAITING, Relaxed, Relaxed).is_err() {\n                // The lock got locked. Not our problem anymore.\n                return;\n            }\n            if self.wake_writer() {\n                return;\n            }\n            // No writers were actually blocked on futex_wait, so we continue\n            // to wake up readers instead, since we can't be sure if we notified a writer.\n            state = READERS_WAITING;\n        }\n\n        // If readers are waiting, wake them all up.\n        if state == READERS_WAITING {\n            if self.state.compare_exchange(state, 0, Relaxed, Relaxed).is_ok() {\n                futex_wake_all(&self.state);\n            }\n        }\n    }"
}