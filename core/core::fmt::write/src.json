{
  "name": "core::fmt::write",
  "span": "$library/core/src/fmt/mod.rs:1630:1: 1630:67",
  "src": "pub fn write(output: &mut dyn Write, fmt: Arguments<'_>) -> Result {\n    if let Some(s) = fmt.as_str() {\n        return output.write_str(s);\n    }\n\n    let mut template = fmt.template;\n    let args = fmt.args;\n\n    let mut arg_index = 0;\n\n    // See comment on `fmt::Arguments` for the details of how the template is encoded.\n\n    // This must match the encoding from `expand_format_args` in\n    // compiler/rustc_ast_lowering/src/format.rs.\n    loop {\n        // SAFETY: We can assume the template is valid.\n        let n = unsafe {\n            let n = template.read();\n            template = template.add(1);\n            n\n        };\n\n        if n == 0 {\n            // End of template.\n            return Ok(());\n        } else if n < 0x80 {\n            // Literal string piece of length `n`.\n\n            // SAFETY: We can assume the strings in the template are valid.\n            let s = unsafe {\n                let s = crate::str::from_raw_parts(template.as_ptr(), n as usize);\n                template = template.add(n as usize);\n                s\n            };\n            output.write_str(s)?;\n        } else if n == 0x80 {\n            // Literal string piece with a 16-bit length.\n\n            // SAFETY: We can assume the strings in the template are valid.\n            let s = unsafe {\n                let len = usize::from(u16::from_le_bytes(template.cast_array().read()));\n                template = template.add(2);\n                let s = crate::str::from_raw_parts(template.as_ptr(), len);\n                template = template.add(len);\n                s\n            };\n            output.write_str(s)?;\n        } else if n == 0xC0 {\n            // Placeholder for next argument with default options.\n            //\n            // Having this as a separate case improves performance for the common case.\n\n            // SAFETY: We can assume the template only refers to arguments that exist.\n            unsafe {\n                args.add(arg_index)\n                    .as_ref()\n                    .fmt(&mut Formatter::new(output, FormattingOptions::new()))?;\n            }\n            arg_index += 1;\n        } else {\n            // SAFETY: We can assume the template is valid.\n            unsafe { assert_unchecked(n > 0xC0) };\n\n            // Placeholder with custom options.\n\n            let mut opt = FormattingOptions::new();\n\n            // SAFETY: We can assume the template is valid.\n            unsafe {\n                if n & 1 != 0 {\n                    opt.flags = u32::from_le_bytes(template.cast_array().read());\n                    template = template.add(4);\n                }\n                if n & 2 != 0 {\n                    opt.width = u16::from_le_bytes(template.cast_array().read());\n                    template = template.add(2);\n                }\n                if n & 4 != 0 {\n                    opt.precision = u16::from_le_bytes(template.cast_array().read());\n                    template = template.add(2);\n                }\n                if n & 8 != 0 {\n                    arg_index = usize::from(u16::from_le_bytes(template.cast_array().read()));\n                    template = template.add(2);\n                }\n            }\n            if n & 16 != 0 {\n                // Dynamic width from a usize argument.\n                // SAFETY: We can assume the template only refers to arguments that exist.\n                unsafe {\n                    opt.width = args.add(opt.width as usize).as_ref().as_u16().unwrap_unchecked();\n                }\n            }\n            if n & 32 != 0 {\n                // Dynamic precision from a usize argument.\n                // SAFETY: We can assume the template only refers to arguments that exist.\n                unsafe {\n                    opt.precision =\n                        args.add(opt.precision as usize).as_ref().as_u16().unwrap_unchecked();\n                }\n            }\n\n            // SAFETY: We can assume the template only refers to arguments that exist.\n            unsafe {\n                args.add(arg_index).as_ref().fmt(&mut Formatter::new(output, opt))?;\n            }\n            arg_index += 1;\n        }\n    }\n}"
}