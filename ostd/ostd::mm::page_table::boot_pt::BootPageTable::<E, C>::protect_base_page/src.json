{
  "name": "ostd::mm::page_table::boot_pt::BootPageTable::<E, C>::protect_base_page",
  "span": "ostd/src/mm/page_table/boot_pt.rs:206:5: 210:6",
  "src": "pub unsafe fn protect_base_page(\n        &mut self,\n        virt_addr: Vaddr,\n        mut op: impl FnMut(&mut PageProperty),\n    ) {\n        let mut pt = self.root_pt;\n        let mut level = C::NR_LEVELS;\n        // Walk to the last level of the page table.\n        while level > 1 {\n            let index = pte_index::<C>(virt_addr, level);\n            let pte_ptr = unsafe { (paddr_to_vaddr(pt * C::BASE_PAGE_SIZE) as *mut E).add(index) };\n            let pte = unsafe { pte_ptr.read() };\n            pt = if !pte.is_present() {\n                panic!(\"protecting an unmapped page in the boot page table\");\n            } else if pte.is_last(level) {\n                // Split the huge page.\n                let child_pte = self.alloc_child();\n                let child_frame_pa = child_pte.paddr();\n                let huge_pa = pte.paddr();\n                for i in 0..nr_subpage_per_huge::<C>() {\n                    let nxt_ptr = unsafe { (paddr_to_vaddr(child_frame_pa) as *mut E).add(i) };\n                    unsafe {\n                        nxt_ptr.write(E::new_page(\n                            huge_pa + i * C::BASE_PAGE_SIZE,\n                            level - 1,\n                            pte.prop(),\n                        ))\n                    };\n                }\n                unsafe { pte_ptr.write(E::new_pt(child_frame_pa)) };\n                child_frame_pa / C::BASE_PAGE_SIZE\n            } else {\n                pte.paddr() / C::BASE_PAGE_SIZE\n            };\n            level -= 1;\n        }\n        // Do protection in the last level page table.\n        let index = pte_index::<C>(virt_addr, 1);\n        let pte_ptr = unsafe { (paddr_to_vaddr(pt * C::BASE_PAGE_SIZE) as *mut E).add(index) };\n        let pte = unsafe { pte_ptr.read() };\n        if !pte.is_present() {\n            panic!(\"protecting an unmapped page in the boot page table\");\n        }\n        let mut prop = pte.prop();\n        op(&mut prop);\n        unsafe { pte_ptr.write(E::new_page(pte.paddr(), 1, prop)) };\n    }"
}