{
  "name": "ostd::arch::boot::smp::count_processors",
  "span": "ostd/src/arch/x86/boot/smp.rs:54:1: 54:48",
  "src": "pub(crate) fn count_processors() -> Option<u32> {\n    let acpi_tables = get_acpi_tables()?;\n    let madt_table = acpi_tables.find_table::<acpi::madt::Madt>().ok()?;\n\n    // According to ACPI spec [1], \"If this bit [the Enabled bit] is set the processor is ready for\n    // use. If this bit is clear and the Online Capable bit is set, system hardware supports\n    // enabling this processor during OS runtime.\"\n    // [1]: https://uefi.org/htmlspecs/ACPI_Spec_6_4_html/05_ACPI_Software_Programming_Model/ACPI_Software_Programming_Model.html#local-apic-flags\n    fn is_usable(flags: u32) -> bool {\n        const ENABLED: u32 = 0b01;\n        const ONLINE_CAPABLE: u32 = 0b10;\n\n        (flags & ENABLED) != 0 || (flags & ONLINE_CAPABLE) != 0\n    }\n\n    // According to ACPI spec [1], \"Logical processors with APIC ID values less than 255 (whether\n    // in XAPIC or X2APIC mode) must use the Processor Local APIC structure to convey their APIC\n    // information to OSPM [..] Logical processors with APIC ID values 255 and greater must use the\n    // Processor Local x2APIC structure [..]\"\n    // [1]: https://uefi.org/htmlspecs/ACPI_Spec_6_4_html/05_ACPI_Software_Programming_Model/ACPI_Software_Programming_Model.html#processor-local-x2apic-structure\n    let is_dup_apic = |id: u32| -> bool {\n        // Check if the APIC entry also shows up as an x2APIC entry.\n        if madt_table.get().entries().any(|e| {\n            matches!(e, MadtEntry::LocalX2Apic(e)\n                if e.x2apic_id == id && is_usable(e.flags))\n        }) {\n            log::warn!(\n                \"Firmware bug: In MADT, APIC ID {} is also listed as an x2APIC ID\",\n                id,\n            );\n            true\n        } else {\n            false\n        }\n    };\n\n    let local_apic_counts = madt_table\n        .get()\n        .entries()\n        .filter(|e| match e {\n            MadtEntry::LocalX2Apic(entry) => {\n                log::trace!(\"Found a local x2APIC entry in MADT: {:?}\", entry);\n                is_usable(entry.flags)\n            }\n            MadtEntry::LocalApic(entry) => {\n                log::trace!(\"Found a local APIC entry in MADT: {:?}\", entry);\n                is_usable(entry.flags) && !is_dup_apic(entry.apic_id as u32)\n            }\n            _ => false,\n        })\n        .count();\n\n    Some(local_apic_counts as u32)\n}"
}