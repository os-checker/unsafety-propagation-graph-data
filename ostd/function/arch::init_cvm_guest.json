{
  "name": "arch::init_cvm_guest",
  "safe": true,
  "callees": {
    "tdx_guest::init_tdx": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": "",
      "adt": {}
    },
    "core::fmt::rt::Argument::<'_>::new_debug": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": "",
      "adt": {}
    },
    "tdx_guest::reduce_unnecessary_ve": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": "",
      "adt": {}
    },
    "core::result::Result::<T, E>::unwrap": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": " Returns the contained [`Ok`] value, consuming the `self` value.\n\n Because this function may panic, its use is generally discouraged.\n Panics are meant for unrecoverable errors, and\n [may abort the entire program][panic-abort].\n\n Instead, prefer to use [the `?` (try) operator][try-operator], or pattern matching\n to handle the [`Err`] case explicitly, or call [`unwrap_or`],\n [`unwrap_or_else`], or [`unwrap_or_default`].\n\n [panic-abort]: https://doc.rust-lang.org/book/ch09-01-unrecoverable-errors-with-panic.html\n [try-operator]: https://doc.rust-lang.org/book/ch09-02-recoverable-errors-with-result.html#a-shortcut-for-propagating-errors-the--operator\n [`unwrap_or`]: Result::unwrap_or\n [`unwrap_or_else`]: Result::unwrap_or_else\n [`unwrap_or_default`]: Result::unwrap_or_default\n\n # Panics\n\n Panics if the value is an [`Err`], with a panic message provided by the\n [`Err`]'s value.\n\n\n # Examples\n\n Basic usage:\n\n ```\n let x: Result<u32, &str> = Ok(2);\n assert_eq!(x.unwrap(), 2);\n ```\n\n ```should_panic\n let x: Result<u32, &str> = Err(\"emergency failure\");\n x.unwrap(); // panics with `emergency failure`\n ```\n",
      "adt": {}
    },
    "tdx_guest::disable_sept_ve": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": "",
      "adt": {}
    },
    "tdx_guest::tdcall::write_td_metadata": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": " Write a TD-scope metadata field (control structure field) of a TD.\n\n - data: data to write to the field.\n\n - write_mask: a 64b write mask to indicate which bits of the value\n   in R8 are to be written to the field.\n\n It returns previous contents of the field.\n",
      "adt": {}
    },
    "core::fmt::rt::Argument::<'_>::new_display": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": "",
      "adt": {}
    },
    "core::fmt::Arguments::<'a>::new": {
      "safe": false,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": "",
      "adt": {}
    },
    "console::early_print": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": " Prints formatted arguments to the console.\n",
      "adt": {}
    },
    "core::panicking::panic_fmt": {
      "safe": true,
      "tags": {
        "tags": [],
        "spec": {},
        "docs": []
      },
      "doc": " The entry point for panicking with a formatted message.\n\n This is designed to reduce the amount of code required at the call\n site as much as possible (so that `panic!()` has as low an impact\n on (e.g.) the inlining of other functions as possible), by moving\n the actual formatting into this shared place.\n",
      "adt": {}
    }
  },
  "adts": {
    "core::result::Result": [
      "Plain",
      "Unknown([Downcast(VariantIdx(1, ThreadLocalIndex)), Field(0, Ty { id: 2931, kind: RigidTy(Adt(AdtDef(DefId { id: 4507, name: \"tdx_guest::tdcall::InitError\" }), GenericArgs([]))) })])",
      "Unknown([Downcast(VariantIdx(1, ThreadLocalIndex)), Field(0, Ty { id: 2931, kind: RigidTy(Adt(AdtDef(DefId { id: 4507, name: \"tdx_guest::tdcall::InitError\" }), GenericArgs([]))) }), Downcast(VariantIdx(2, ThreadLocalIndex)), Field(0, Ty { id: 2801, kind: RigidTy(Adt(AdtDef(DefId { id: 4508, name: \"tdx_guest::tdcall::TdCallError\" }), GenericArgs([]))) })])",
      "Unknown([Downcast(VariantIdx(0, ThreadLocalIndex)), Field(0, Ty { id: 2935, kind: RigidTy(Adt(AdtDef(DefId { id: 4509, name: \"tdx_guest::tdcall::TdgVpInfo\" }), GenericArgs([]))) })])"
    ],
    "tdx_guest::tdcall::TdCallError": [
      "Plain",
      "Ref",
      "Unknown([Field(0, Ty { id: 2933, kind: RigidTy(Ref(Region { kind: ReErased }, Ty { id: 2801, kind: RigidTy(Adt(AdtDef(DefId { id: 4508, name: \"tdx_guest::tdcall::TdCallError\" }), GenericArgs([]))) }, Not)) })])"
    ],
    "core::fmt::rt::Argument": [
      "Plain"
    ],
    "tdx_guest::tdcall::TdgVpInfo": [
      "Plain",
      "Unknown([Field(1, Ty { id: 2938, kind: RigidTy(Adt(AdtDef(DefId { id: 4511, name: \"tdx_guest::TdAttributes\" }), GenericArgs([]))) })])",
      "Unknown([Field(0, Ty { id: 2943, kind: RigidTy(Adt(AdtDef(DefId { id: 4514, name: \"tdx_guest::tdcall::Gpaw\" }), GenericArgs([]))) })])"
    ],
    "tdx_guest::TdAttributes": [
      "Plain",
      "Ref",
      "RefVariantField(VariantIdx(None)-FieldIdx(Some(0)))",
      "RefVariantField(VariantIdx(None)-FieldIdx(Some(1)))"
    ],
    "tdx_guest::tdcall::Gpaw": [
      "Ref",
      "Unknown([Field(0, Ty { id: 2944, kind: RigidTy(Ref(Region { kind: ReErased }, Ty { id: 2943, kind: RigidTy(Adt(AdtDef(DefId { id: 4514, name: \"tdx_guest::tdcall::Gpaw\" }), GenericArgs([]))) }, Not)) })])",
      "Unknown([Field(1, Ty { id: 2946, kind: RigidTy(Ref(Region { kind: ReErased }, Ty { id: 2938, kind: RigidTy(Adt(AdtDef(DefId { id: 4511, name: \"tdx_guest::TdAttributes\" }), GenericArgs([]))) }, Not)) })])"
    ],
    "core::fmt::Arguments": [
      "Plain"
    ]
  },
  "path": 1556,
  "span": "ostd/src/arch/x86/mod.rs:23:1: 50:2",
  "src": "pub(crate) fn init_cvm_guest() {\n    use ::tdx_guest::{\n        disable_sept_ve, init_tdx, metadata, reduce_unnecessary_ve,\n        tdcall::{InitError, write_td_metadata},\n    };\n    match init_tdx() {\n        Ok(td_info) => {\n            reduce_unnecessary_ve().unwrap();\n            disable_sept_ve(td_info.attributes).unwrap();\n            // Enable notification for zero step attack detection.\n            write_td_metadata(metadata::NOTIFY_ENABLES, 1, 1).unwrap();\n\n            crate::early_println!(\n                \"[kernel] Intel TDX initialized\\n[kernel] td gpaw: {}, td attributes: {:?}\",\n                td_info.gpaw,\n                td_info.attributes\n            );\n        }\n        Err(InitError::TdxGetVpInfoError(td_call_error)) => {\n            panic!(\n                \"[kernel] Intel TDX not initialized, Failed to get TD info: {:?}\",\n                td_call_error\n            );\n        }\n        // The machine has no TDX support.\n        Err(_) => {}\n    }\n}",
  "mir": "fn arch::init_cvm_guest() -> () {\n    let mut _0: ();\n    let mut _1: core::result::Result<tdx_guest::tdcall::TdgVpInfo, tdx_guest::tdcall::InitError>;\n    let mut _2: isize;\n    let mut _3: isize;\n    let  _4: tdx_guest::tdcall::TdgVpInfo;\n    let  _5: ();\n    let mut _6: core::result::Result<(), tdx_guest::TopologyError>;\n    let  _7: ();\n    let mut _8: core::result::Result<(), tdx_guest::SeptVeError>;\n    let mut _9: tdx_guest::TdAttributes;\n    let  _10: u64;\n    let mut _11: core::result::Result<u64, tdx_guest::tdcall::TdCallError>;\n    let  _12: ();\n    let mut _13: core::fmt::Arguments<'_>;\n    let  _14: (&tdx_guest::tdcall::Gpaw, &tdx_guest::TdAttributes);\n    let mut _15: &tdx_guest::tdcall::Gpaw;\n    let mut _16: &tdx_guest::TdAttributes;\n    let  _17: [core::fmt::rt::Argument<'_>; 2];\n    let mut _18: core::fmt::rt::Argument<'_>;\n    let mut _19: core::fmt::rt::Argument<'_>;\n    let mut _20: &[u8; 73];\n    let  _21: &[core::fmt::rt::Argument<'_>; 2];\n    let  _22: tdx_guest::tdcall::TdCallError;\n    let  _23: !;\n    let mut _24: core::fmt::Arguments<'_>;\n    let  _25: (&tdx_guest::tdcall::TdCallError,);\n    let mut _26: &tdx_guest::tdcall::TdCallError;\n    let  _27: [core::fmt::rt::Argument<'_>; 1];\n    let mut _28: core::fmt::rt::Argument<'_>;\n    let mut _29: &[u8; 62];\n    let  _30: &[core::fmt::rt::Argument<'_>; 1];\n    let mut _31: &tdx_guest::tdcall::TdCallError;\n    let mut _32: &tdx_guest::tdcall::Gpaw;\n    let mut _33: &tdx_guest::TdAttributes;\n    debug td_info => _4;\n    debug args => _14;\n    debug args => _17;\n    debug td_call_error => _22;\n    debug args => _25;\n    debug args => _27;\n    bb0: {\n        StorageLive(_1);\n        _1 = tdx_guest::init_tdx() -> [return: bb1, unwind unreachable];\n    }\n    bb1: {\n        _3 = discriminant(_1);\n        switchInt(move _3) -> [0: bb5, 1: bb3, otherwise: bb2];\n    }\n    bb2: {\n        unreachable;\n    }\n    bb3: {\n        _2 = discriminant(((_1 as variant#1).0: tdx_guest::tdcall::InitError));\n        switchInt(move _2) -> [2: bb4, otherwise: bb18];\n    }\n    bb4: {\n        StorageLive(_22);\n        _22 = move ((((_1 as variant#1).0: tdx_guest::tdcall::InitError) as variant#2).0: tdx_guest::tdcall::TdCallError);\n        StorageLive(_24);\n        StorageLive(_25);\n        StorageLive(_26);\n        _26 = &_22;\n        _25 = (move _26);\n        StorageDead(_26);\n        StorageLive(_27);\n        StorageLive(_28);\n        _31 = (_25.0: &tdx_guest::tdcall::TdCallError);\n        _28 = core::fmt::rt::Argument::<'_>::new_debug::<tdx_guest::tdcall::TdCallError>(_31) -> [return: bb16, unwind unreachable];\n    }\n    bb5: {\n        StorageLive(_4);\n        _4 = move ((_1 as variant#0).0: tdx_guest::tdcall::TdgVpInfo);\n        StorageLive(_6);\n        _6 = tdx_guest::reduce_unnecessary_ve() -> [return: bb6, unwind unreachable];\n    }\n    bb6: {\n        _5 = core::result::Result::<(), tdx_guest::TopologyError>::unwrap(move _6) -> [return: bb7, unwind unreachable];\n    }\n    bb7: {\n        StorageDead(_6);\n        StorageLive(_8);\n        StorageLive(_9);\n        _9 = (_4.1: tdx_guest::TdAttributes);\n        _8 = tdx_guest::disable_sept_ve(move _9) -> [return: bb8, unwind unreachable];\n    }\n    bb8: {\n        StorageDead(_9);\n        _7 = core::result::Result::<(), tdx_guest::SeptVeError>::unwrap(move _8) -> [return: bb9, unwind unreachable];\n    }\n    bb9: {\n        StorageDead(_8);\n        StorageLive(_10);\n        StorageLive(_11);\n        _11 = tdx_guest::tdcall::write_td_metadata(tdx_guest::metadata::NOTIFY_ENABLES, 1_u64, 1_u64) -> [return: bb10, unwind unreachable];\n    }\n    bb10: {\n        _10 = core::result::Result::<u64, tdx_guest::tdcall::TdCallError>::unwrap(move _11) -> [return: bb11, unwind unreachable];\n    }\n    bb11: {\n        StorageDead(_11);\n        StorageDead(_10);\n        StorageLive(_13);\n        StorageLive(_14);\n        StorageLive(_15);\n        _15 = &(_4.0: tdx_guest::tdcall::Gpaw);\n        StorageLive(_16);\n        _16 = &(_4.1: tdx_guest::TdAttributes);\n        _14 = (move _15, move _16);\n        StorageDead(_16);\n        StorageDead(_15);\n        StorageLive(_17);\n        StorageLive(_18);\n        _32 = (_14.0: &tdx_guest::tdcall::Gpaw);\n        _18 = core::fmt::rt::Argument::<'_>::new_display::<tdx_guest::tdcall::Gpaw>(_32) -> [return: bb12, unwind unreachable];\n    }\n    bb12: {\n        StorageLive(_19);\n        _33 = (_14.1: &tdx_guest::TdAttributes);\n        _19 = core::fmt::rt::Argument::<'_>::new_debug::<tdx_guest::TdAttributes>(_33) -> [return: bb13, unwind unreachable];\n    }\n    bb13: {\n        _17 = [move _18, move _19];\n        StorageDead(_19);\n        StorageDead(_18);\n        StorageLive(_20);\n        _20 = b\"1[kernel] Intel TDX initialized\\n[kernel] td gpaw: \\xc0\\x11, td attributes: \\xc0\\x01\\n\\x00\";\n        _21 = &_17;\n        _13 = core::fmt::Arguments::<'_>::new::<73, 2>(move _20, _21) -> [return: bb14, unwind unreachable];\n    }\n    bb14: {\n        StorageDead(_20);\n        _12 = console::early_print(move _13) -> [return: bb15, unwind unreachable];\n    }\n    bb15: {\n        StorageDead(_13);\n        StorageDead(_17);\n        StorageDead(_14);\n        StorageDead(_4);\n        goto -> bb18;\n    }\n    bb16: {\n        _27 = [move _28];\n        StorageDead(_28);\n        StorageLive(_29);\n        _29 = b\";[kernel] Intel TDX not initialized, Failed to get TD info: \\xc0\\x00\";\n        _30 = &_27;\n        _24 = core::fmt::Arguments::<'_>::new::<62, 1>(move _29, _30) -> [return: bb17, unwind unreachable];\n    }\n    bb17: {\n        StorageDead(_29);\n        _23 = core::panicking::panic_fmt(move _24) -> unwind unreachable;\n    }\n    bb18: {\n        StorageDead(_1);\n        return;\n    }\n}\n",
  "doc": "",
  "tags": {
    "tags": [],
    "spec": {},
    "docs": []
  }
}