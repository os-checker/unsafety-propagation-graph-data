{
  "name": "ostd::arch::timer::hpet::Hpet::new",
  "span": "ostd/src/arch/x86/timer/hpet.rs:54:5: 54:53",
  "src": "unsafe fn new(base_address: NonNull<u8>) -> Hpet {\n        // SAFETY: The safety is upheld by the caller.\n        let (\n            information_register,\n            general_configuration_register,\n            general_interrupt_status_register,\n        ) = unsafe {\n            (\n                VolatileRef::new_read_only(base_address.add(OFFSET_ID_REGISTER).cast::<u32>()),\n                VolatileRef::new(\n                    base_address\n                        .add(OFFSET_CONFIGURATION_REGISTER)\n                        .cast::<u32>(),\n                ),\n                VolatileRef::new(\n                    base_address\n                        .add(OFFSET_INTERRUPT_STATUS_REGISTER)\n                        .cast::<u32>(),\n                ),\n            )\n        };\n\n        let num_comparator = ((information_register.as_ptr().read() & 0x1F00) >> 8) as u8 + 1;\n        let num_comparator = num_comparator as usize;\n\n        // FIXME: We now trust the hardware. We should instead find a way to check that\n        // `num_comparator` are reasonable values before proceeding.\n\n        let mut comparators = Vec::with_capacity(num_comparator);\n        for i in 0..num_comparator {\n            // SAFETY: The safety is upheld by the caller and the correctness of the information\n            // value.\n            let comp = unsafe {\n                VolatileRef::new(\n                    base_address\n                        .add(0x100)\n                        .add(i * 0x20)\n                        .cast::<HpetTimerRegister>(),\n                )\n            };\n            comparators.push(comp);\n        }\n\n        let irq = IrqLine::alloc().unwrap();\n        // FIXME: The index of HPET interrupt needs to be tested.\n        let irq = IRQ_CHIP.get().unwrap().map_isa_pin_to(irq, 0).unwrap();\n\n        Hpet {\n            information_register,\n            _general_configuration_register: general_configuration_register,\n            _general_interrupt_status_register: general_interrupt_status_register,\n            _timer_registers: comparators,\n            _irq: irq,\n        }\n    }"
}