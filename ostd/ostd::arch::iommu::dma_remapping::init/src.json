{
  "name": "ostd::arch::iommu::dma_remapping::init",
  "span": "ostd/src/arch/x86/iommu/dma_remapping/mod.rs:123:1: 123:14",
  "src": "pub fn init() {\n    if !IOMMU_REGS\n        .get()\n        .unwrap()\n        .lock()\n        .read_capability()\n        .supported_adjusted_guest_address_widths()\n        .contains(CapabilitySagaw::AGAW_39BIT_3LP)\n    {\n        warn!(\"[IOMMU] 3-level page tables not supported, disabling DMA remapping\");\n        return;\n    }\n\n    // Create a Root Table instance.\n    let mut root_table = RootTable::new();\n    // For all PCI devices, use the same page table.\n    //\n    // TODO: The BIOS reserves some memory regions as DMA targets and lists them in the Reserved\n    // Memory Region Reporting (RMRR) structures. These regions must be mapped for the hardware or\n    // firmware to function properly. For more details, see Intel(R) Virtualization Technology for\n    // Directed I/O (Revision 5.0), 3.16 Handling Requests to Reserved System Memory.\n    let page_table = PageTable::<IommuPtConfig>::empty();\n    for table in PciDeviceLocation::all() {\n        root_table.specify_device_page_table(table, unsafe { page_table.shallow_copy() })\n    }\n    PAGE_TABLE.call_once(|| SpinLock::new(root_table));\n\n    // Enable DMA remapping.\n    let mut iommu_regs = IOMMU_REGS.get().unwrap().lock();\n    iommu_regs.enable_dma_remapping(PAGE_TABLE.get().unwrap());\n    info!(\"[IOMMU] DMA remapping enabled\");\n}"
}