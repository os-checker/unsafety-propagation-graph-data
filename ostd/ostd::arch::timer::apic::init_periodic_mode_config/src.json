{
  "name": "ostd::arch::timer::apic::init_periodic_mode_config",
  "span": "ostd/src/arch/x86/timer/apic.rs:104:1: 104:31",
  "src": "fn init_periodic_mode_config() {\n    info!(\"[Timer]: Enable APIC periodic mode\");\n\n    // Allocate IRQ\n    let mut irq = IrqLine::alloc().unwrap();\n    irq.on_active(pit_callback);\n\n    // Enable PIT\n    super::pit::init(OperatingMode::RateGenerator);\n    let irq = super::pit::enable_interrupt(irq);\n\n    // Set APIC timer count\n    let preempt_guard = disable_preempt();\n    let apic = apic::get_or_init(&preempt_guard as _);\n    apic.set_timer_div_config(DivideConfig::Divide64);\n    apic.set_timer_init_count(0xFFFF_FFFF);\n\n    // Wait until `CONFIG` is ready\n    loop {\n        crate::arch::irq::enable_local_and_halt();\n\n        // Disable local IRQs so they won't come after checking `CONFIG`\n        // but before halting the CPU.\n        crate::arch::irq::disable_local();\n\n        if CONFIG.is_completed() {\n            break;\n        }\n    }\n\n    // Disable PIT\n    drop(irq);\n\n    fn pit_callback(_trap_frame: &TrapFrame) {\n        static IN_TIME: AtomicU64 = AtomicU64::new(0);\n        static APIC_FIRST_COUNT: AtomicU64 = AtomicU64::new(0);\n        // Set a certain times of callbacks to calculate the frequency\n        // The number of callbacks needed to calculate the APIC timer frequency.\n        // This is set to 1/10th of the TIMER_FREQ to ensure enough samples for accurate calculation.\n        const CALLBACK_TIMES: u64 = TIMER_FREQ / 10;\n\n        let preempt_guard = disable_preempt();\n        let apic = apic::get_or_init(&preempt_guard as _);\n\n        let apic_current_count = 0xFFFF_FFFF - apic.timer_current_count();\n\n        if IN_TIME.load(Ordering::Relaxed) < CALLBACK_TIMES || CONFIG.is_completed() {\n            if IN_TIME.load(Ordering::Relaxed) == 0 {\n                APIC_FIRST_COUNT.store(apic_current_count, Ordering::Relaxed);\n            }\n            IN_TIME.fetch_add(1, Ordering::Relaxed);\n            return;\n        }\n\n        // Stop APIC Timer\n        apic.set_timer_init_count(0);\n\n        let apic_first_count = APIC_FIRST_COUNT.load(Ordering::Relaxed);\n        let apic_init_count = (apic_current_count - apic_first_count) / CALLBACK_TIMES;\n        info!(\n            \"APIC timer: first {:#x}, current {:#x}, init {:#x}\",\n            apic_first_count, apic_current_count, apic_init_count,\n        );\n        CONFIG.call_once(|| Config::PeriodicMode {\n            init_count: apic_init_count,\n        });\n    }\n}"
}