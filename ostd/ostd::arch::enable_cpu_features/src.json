{
  "name": "ostd::arch::enable_cpu_features",
  "span": "ostd/src/arch/x86/mod.rs:152:1: 152:36",
  "src": "pub(crate) fn enable_cpu_features() {\n    use cpu::extension::{IsaExtensions, has_extensions};\n    use x86_64::registers::{\n        control::{Cr0Flags, Cr4Flags},\n        xcontrol::XCr0Flags,\n    };\n\n    cpu::extension::init();\n\n    let mut cr0 = x86_64::registers::control::Cr0::read();\n    cr0 |= Cr0Flags::WRITE_PROTECT;\n    // These FPU control bits should be set for new CPUs (e.g., all CPUs with 64-bit support) and\n    // modern OSes. See recommendation from \"Intel(R) 64 and IA-32 Architectures Software\n    // Developer's Manual\" - Volume 3 - Section 10.2.1, Configuring the x87 FPU Environment.\n    cr0 |= Cr0Flags::NUMERIC_ERROR | Cr0Flags::MONITOR_COPROCESSOR;\n    unsafe { x86_64::registers::control::Cr0::write(cr0) };\n\n    let mut cr4 = x86_64::registers::control::Cr4::read();\n    cr4 |= Cr4Flags::OSFXSR | Cr4Flags::OSXMMEXCPT_ENABLE | Cr4Flags::PAGE_GLOBAL;\n    if has_extensions(IsaExtensions::XSAVE) {\n        cr4 |= Cr4Flags::OSXSAVE;\n    }\n    // For now, we unconditionally require the `rdfsbase`, `wrfsbase`, `rdgsbase`, and `wrgsbase`\n    // instructions because they are used when switching contexts, getting the address of a\n    // CPU-local variable, e.t.c. Meanwhile, this is at a very early stage of the boot process, so\n    // we want to avoid failing immediately even if we cannot enable these instructions (though the\n    // kernel will certainly fail later when they are absent).\n    //\n    // Note that this also enables the userspace to control their own FS/GS bases, which requires\n    // the kernel to properly deal with the arbitrary base values set by the userspace program.\n    if has_extensions(IsaExtensions::FSGSBASE) {\n        cr4 |= Cr4Flags::FSGSBASE;\n    }\n    unsafe { x86_64::registers::control::Cr4::write(cr4) };\n\n    if has_extensions(IsaExtensions::XSAVE) {\n        let mut xcr0 = x86_64::registers::xcontrol::XCr0::read();\n        xcr0 |= XCr0Flags::SSE;\n        if has_extensions(IsaExtensions::AVX) {\n            xcr0 |= XCr0Flags::AVX;\n        }\n        if has_extensions(IsaExtensions::AVX512F) {\n            xcr0 |= XCr0Flags::OPMASK | XCr0Flags::ZMM_HI256 | XCr0Flags::HI16_ZMM;\n        }\n        unsafe { x86_64::registers::xcontrol::XCr0::write(xcr0) };\n    }\n\n    cpu::context::enable_essential_features();\n\n    mm::enable_essential_features();\n}"
}