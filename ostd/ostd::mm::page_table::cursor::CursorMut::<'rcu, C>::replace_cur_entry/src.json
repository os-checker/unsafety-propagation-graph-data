{
  "name": "ostd::mm::page_table::cursor::CursorMut::<'rcu, C>::replace_cur_entry",
  "span": "ostd/src/mm/page_table/cursor/mod.rs:586:5: 586:85",
  "src": "fn replace_cur_entry(&mut self, new_child: Child<C>) -> Option<PageTableFrag<C>> {\n        let rcu_guard = self.0.rcu_guard;\n\n        let va = self.0.va;\n        let level = self.0.level;\n\n        let old = self.0.cur_entry().replace(new_child);\n        match old {\n            Child::None => None,\n            Child::Frame(pa, ch_level, prop) => {\n                debug_assert_eq!(ch_level, level);\n\n                // SAFETY:\n                // This is part of (if `split_huge` happens) a page table item mapped\n                // with a previous call to `C::item_into_raw`, where:\n                //  - The physical address and the paging level match it;\n                //  - The item part is now unmapped so we can take its ownership;\n                //  - The `AVAIL1` flag is preserved by the cursor and the callers of\n                //    the unsafe `protect_next` method.\n                let item = unsafe { C::item_from_raw(pa, level, prop) };\n                Some(PageTableFrag::Mapped { va, item })\n            }\n            Child::PageTable(pt) => {\n                debug_assert_eq!(pt.level(), level - 1);\n\n                if !C::TOP_LEVEL_CAN_UNMAP && level == C::NR_LEVELS {\n                    let _ = ManuallyDrop::new(pt); // leak it to make shared PTs stay `'static`.\n                    panic!(\"Unmapping shared kernel page table nodes\");\n                }\n\n                // SAFETY: We must have locked this node.\n                let locked_pt = unsafe { pt.borrow().make_guard_unchecked(rcu_guard) };\n                // SAFETY:\n                //  - We checked that we are not unmapping shared kernel page table nodes.\n                //  - We must have locked the entire sub-tree since the range is locked.\n                let num_frames =\n                    unsafe { locking::dfs_mark_stray_and_unlock(rcu_guard, locked_pt) };\n\n                Some(PageTableFrag::StrayPageTable {\n                    pt: (*pt).clone().into(),\n                    va,\n                    len: page_size::<C>(self.0.level),\n                    num_frames,\n                })\n            }\n        }\n    }"
}