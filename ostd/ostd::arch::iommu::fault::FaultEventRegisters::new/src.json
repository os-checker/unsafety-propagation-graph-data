{
  "name": "ostd::arch::iommu::fault::FaultEventRegisters::new",
  "span": "ostd/src/arch/x86/iommu/fault.rs:42:5: 42:60",
  "src": "unsafe fn new(base_register_vaddr: NonNull<u8>) -> Self {\n        // SAFETY: The safety is upheld by the caller.\n        let (capability, status, mut control, mut data, mut address, upper_address) = unsafe {\n            let base = base_register_vaddr;\n            (\n                // capability\n                VolatileRef::new_read_only(base.add(0x08).cast::<u64>()),\n                // status\n                VolatileRef::new(base.add(0x34).cast::<u32>()),\n                // control\n                VolatileRef::new(base.add(0x38).cast::<u32>()),\n                // data\n                VolatileRef::new(base.add(0x3c).cast::<u32>()),\n                // address\n                VolatileRef::new(base.add(0x40).cast::<u32>()),\n                // upper_address\n                VolatileRef::new(base.add(0x44).cast::<u32>()),\n            )\n        };\n\n        let capability_val = Capability::new(capability.as_ptr().read());\n        let length = capability_val.fault_recording_number() as usize + 1;\n        let offset = (capability_val.fault_recording_register_offset() as usize) * 16;\n\n        // FIXME: We now trust the hardware. We should instead find a way to check that `length`\n        // and `offset` are reasonable values before proceeding.\n\n        let mut recordings = Vec::with_capacity(length);\n        for i in 0..length {\n            // SAFETY: The safety is upheld by the caller and the correctness of the capability\n            // value.\n            recordings.push(unsafe {\n                VolatileRef::new(base_register_vaddr.add(offset).add(i * 16).cast::<u128>())\n            })\n        }\n\n        let mut fault_irq = IrqLine::alloc().unwrap();\n        fault_irq.on_active(iommu_fault_handler);\n\n        // Set page fault interrupt vector and address\n        data.as_mut_ptr().write(fault_irq.num() as u32);\n        address.as_mut_ptr().write(0xFEE0_0000);\n        control.as_mut_ptr().write(0);\n\n        FaultEventRegisters {\n            status,\n            _control: control,\n            _data: data,\n            _address: address,\n            _upper_address: upper_address,\n            recordings,\n            _fault_irq: fault_irq,\n        }\n    }"
}