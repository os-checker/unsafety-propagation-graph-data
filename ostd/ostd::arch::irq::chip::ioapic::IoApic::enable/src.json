{
  "name": "ostd::arch::irq::chip::ioapic::IoApic::enable",
  "span": "ostd/src/arch/x86/irq/chip/ioapic.rs:70:5: 70:76",
  "src": "pub(super) fn enable(&mut self, index: u8, irq: &IrqLine) -> Result<()> {\n        if index > self.max_redirection_entry {\n            return Err(Error::InvalidArgs);\n        }\n\n        // SAFETY: `index` is inbound. The redirection table is safe to read.\n        let value = unsafe { self.access.read(IoApicAccess::IOREDTBL + 2 * index) };\n        if value.get_bits(0..8) as u8 != 0 {\n            return Err(Error::AccessDenied);\n        }\n\n        if let Some(remapping_index) = irq.remapping_index() {\n            // Intel(R) Virtualization Technology for Directed I/O (Revision 5.0), Section 5.1.5.1\n            // I/OxAPIC Programming says \"Bit 48 in the I/OxAPIC RTE is Set to indicate the\n            // Interrupt is in Remappable format.\"\n            let mut value: u64 = irq.num() as u64 | 0x1_0000_0000_0000;\n\n            // \"The Interrupt_Index[14:0] is programmed in bits 63:49 of the I/OxAPIC RTE. The most\n            // significant bit of the Interrupt_Index (Interrupt_Index[15]) is programmed in bit 11\n            // of the I/OxAPIC RTE.\"\n            value |= ((remapping_index & 0x8000) >> 4) as u64;\n            value |= (remapping_index as u64 & 0x7FFF) << 49;\n\n            // SAFETY: `index` is inbound. It is safe to enable the redirection entry with the\n            // correct remapping index.\n            unsafe {\n                self.access.write(\n                    IoApicAccess::IOREDTBL + 2 * index,\n                    value.get_bits(0..32) as u32,\n                );\n                self.access.write(\n                    IoApicAccess::IOREDTBL + 2 * index + 1,\n                    value.get_bits(32..64) as u32,\n                );\n            }\n        } else {\n            // SAFETY: `index` is inbound. It is safe to enable the redirection entry with the\n            // legal IRQ number.\n            unsafe {\n                self.access\n                    .write(IoApicAccess::IOREDTBL + 2 * index, irq.num() as u32);\n                self.access.write(IoApicAccess::IOREDTBL + 2 * index + 1, 0);\n            }\n        }\n\n        Ok(())\n    }"
}