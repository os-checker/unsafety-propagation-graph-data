{
  "name": "ostd::arch::boot::linux_boot::parse_memory_regions",
  "span": "ostd/src/arch/x86/boot/linux_boot/mod.rs:131:1: 131:71",
  "src": "fn parse_memory_regions(boot_params: &BootParams) -> MemoryRegionArray {\n    let mut regions = MemoryRegionArray::new();\n\n    // Add regions from E820.\n    let num_entries = boot_params.e820_entries as usize;\n    for e820_entry in &boot_params.e820_table[0..num_entries] {\n        regions\n            .push(MemoryRegion::new(\n                e820_entry.addr.try_into().unwrap(),\n                e820_entry.size.try_into().unwrap(),\n                e820_entry.typ.into(),\n            ))\n            .unwrap();\n    }\n\n    // Add the framebuffer region.\n    if let Some(fb) = parse_framebuffer_info(boot_params) {\n        regions.push(MemoryRegion::framebuffer(&fb)).unwrap();\n    }\n\n    // Add the kernel region.\n    regions.push(MemoryRegion::kernel()).unwrap();\n\n    // Add the initramfs region.\n    if let Some(initramfs) = parse_initramfs(boot_params) {\n        regions.push(MemoryRegion::module(initramfs)).unwrap();\n    }\n\n    // Add the AP boot code region that will be copied into by the BSP.\n    regions\n        .push(super::smp::reclaimable_memory_region())\n        .unwrap();\n\n    // Add the region of the kernel cmdline since some bootloaders do not provide it.\n    if let Some(kcmdline) = parse_kernel_commandline(boot_params) {\n        regions\n            .push(MemoryRegion::module(kcmdline.as_bytes()))\n            .unwrap();\n    }\n\n    // FIXME: Early versions of TDVF did not correctly report the location of AP's page tables as\n    // EfiACPIMemoryNVS. We need to manually reserve this memory region to prevent them from being\n    // corrupted. TDVF has now been upstreamed to OVMF, and this issue has been fixed in OVMF\n    // stable-202411 or later. See the commit for details:\n    // <https://github.com/tianocore/edk2/commit/383f729ac096b8deb279933fce86e83a5f7f5ec7>.\n    if_tdx_enabled!({\n        // The definition of these constants can be found in:\n        // <https://github.com/tianocore/edk2/blob/a7ab45ace25c4b987994158687d04de07ed20a96/OvmfPkg/IntelTdx/IntelTdxX64.fdf#L64-L71>\n        // <https://github.com/tianocore/edk2/blob/a7ab45ace25c4b987994158687d04de07ed20a96/OvmfPkg/Include/Fdf/OvmfPkgDefines.fdf.inc#L106>\n        regions\n            .push(MemoryRegion::new(\n                // PcdOvmfSecPageTablesBase = $(MEMFD_BASE_ADDRESS) + 0x000000 = 0x800000\n                0x800000,\n                // PcdOvmfSecPageTablesSize = 0x006000\n                0x006000,\n                // EfiACPIMemoryNVS\n                MemoryRegionType::NonVolatileSleep,\n            ))\n            .unwrap();\n    });\n\n    regions.into_non_overlapping()\n}"
}